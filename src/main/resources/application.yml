spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    # Docker 환경에서 사용할 MySQL 설정
    url: jdbc:mysql://mysql:3306/CSmart?serverTimezone=Asia/Seoul&useSSL=false&allowPublicKeyRetrieval=true
    username: ${RDS_USERNAME}
    password: ${RDS_PASSWORD}
    # AWS RDS 설정 (운영 환경용)
    # url: jdbc:mysql://csmartdb.cpoeeaowebbq.ap-northeast-2.rds.amazonaws.com:3306/CSmart?serverTimezone=Asia/Seoul&useSSL=false
    # username: ${RDS_USERNAME}
    # password: ${RDS_PASSWORD}

  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        show_sql: true
        format_sql: true
        use_sql_comments: true
        default_batch_fetch_size: 1000

  sql:
    init:
      mode: never

  # Redis 설정 (시멘틱 캐싱용)
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 2000ms
      jedis:
        pool:
          max-active: 8
          max-wait: -1ms
          max-idle: 8
          min-idle: 0

server:
  port: 8080
  forward-headers-strategy: framework
  tomcat:
    remoteip:
      protocol-header: X-Forwarded-Proto
      remote-ip-header: X-Forwarded-For

jwt:
  secret: ${JWT_SECRET_KEY:dev-jwt-secret-key-must-be-at-least-256-bits-for-security}
  access-token-validity: ${JWT_ACCESS_TOKEN_TIME:2592000000}  # 30일 (테스트용)
  refresh-token-validity: ${JWT_REFRESH_TOKEN_TIME:31536000000}  # 365일 (테스트용)

# 카카오톡 웹훅 서비스 설정
kakao:
  webhook:
    url:
      admin: ${KAKAO_WEBHOOK_URL_ADMIN:http://kakao-webhook-admin:3001}
      teacher: ${KAKAO_WEBHOOK_URL_TEACHER:http://kakao-webhook-teacher:3002}
    timeout: ${KAKAO_WEBHOOK_TIMEOUT:5000}
  bot:
    admin-id: ${KAKAO_BOT_ADMIN_ID:68cbb775539054197042f1ab}
    teacher-id: ${KAKAO_BOT_TEACHER_ID:6905d80853905419704f6d52}

ingest:
  api-key: ${INGEST_API_KEY:dev-ingest-key}

langgraph:
  url: ${LANGGRAPH_URL:http://csmart-langraph:8000}

gemini:
  api-key: ${GEMINI_API_KEY}
  url: https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent

# 시멘틱 캐싱 설정
semantic-cache:
  similarity-threshold: 0.92  # 92% 이상 유사하면 캐시 히트
  cache-ttl: 604800           # 7일 (초 단위)
  # 주제 키워드 필터링 활성화: 과목명(영어, 수학 등)이 다르면 무조건 제외
  embedding:
    model: text-embedding-004  # Google Embedding 모델
    dimensions: 768

# Spring Boot Actuator (헬스체크용)
management:
  endpoints:
    web:
      exposure:
        include: health,info,circuitbreakers
  endpoint:
    health:
      show-details: always

# Resilience4j Circuit Breaker 설정
resilience4j:
  circuitbreaker:
    instances:
      gemini-api:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        slowCallRateThreshold: 100
        slowCallDurationThreshold: 5s
      langgraph-api:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        slowCallRateThreshold: 100
        slowCallDurationThreshold: 10s
  timelimiter:
    instances:
      gemini-api:
        timeoutDuration: 30s
      langgraph-api:
        timeoutDuration: 60s

# Rate Limiting 설정
rate-limit:
  default:
    limit: 100  # 기본: 1분에 100회
    window: 60  # 60초
  ai:
    limit: 20   # AI API: 1분에 20회 (비용 절감)
    window: 60
  webhook:
    limit: 50   # 웹훅: 1분에 50회 (DDoS 방지)
    window: 60
